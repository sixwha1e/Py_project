#-*-coding:utf-8-*-

import requests
import bs4
import re
import xlwt
import time

def get_html(url):
    headers = {'user-agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10.12; rv:50.0) Gecko/20100101 Firefox/50.0'}
    r = requests.get(url, headers=headers)
    html = r.text
    return html

def get_date(html):
    rex = r'<td class="date">(.*?)</td>'
    date_list = re.findall(rex, html, re.DOTALL)
    return date_list

def get_author(html):
    rex = r'<td class="author">.*?<a href=".*?" title="(.*?)">'
    author_list = re.findall(rex, html, re.DOTALL)
    return author_list

def get_platform(html):
    rex = r'<td class="platform">.*?<a href=".*?">(.*?)</a>'
    plats = re.findall(rex, html, re.DOTALL)
    platform_list = []
    for plat in plats:
        plat = plat.strip()
        platform_list.append(plat)
    return platform_list

def get_url(html):
    soup = bs4.BeautifulSoup(html, 'html.parser')
    dlinks = soup.findAll('td', class_='dlink')
    url_list = []
    for link in dlinks:
        url = link.a['href']
        url_list.append(url)
    # 50/page
    return url_list


def set_style():
    style = xlwt.XFStyle()
    font = xlwt.Font()
    font.name = 'Times New Roman'
    font.bold = False
    font.colour_index = 4
    font.height = 200
    style.font = font

    return style

def write_excel(rows):
    f = xlwt.Workbook() #创建工作簿

    sheet1 = f.add_sheet(u'sheet', cell_overwrite_ok=True) #创建sheet
    row0 = ['Year', 'Month', 'Author', 'Platform']
    for k in range(len(row0)):
        sheet1.write(0, k, row0[k], set_style())

    length = len(rows)
    for j in range(length): #纵向循环
        for i in range(len(row0)): #横向循环
            sheet1.write(j,i,rows[j][i],set_style())

    f.save('/Users/bingdaojueai/PycharmProjects/Exploit-db/excel/%s.xlsx' % int(time.time()*10000000))


def get_year(date_list):
    year_list = []
    for date in date_list:
        year = date[0:4]
        year_list.append(year)
    return year_list

def get_month(date_list):
    month_list = []
    for date in date_list:
        month = date[5:7]
        month_list.append(month)
    return month_list


def test(url):
    html = get_html(url)
    dates = get_date(html)
    year = get_year(dates)
    month = get_month(dates)
    platforms = get_platform(html)
    authors = get_author(html)
    rows = []
    for i in range(len(dates)):
        if year[i] == '2016':
            rows.append([year[i], month[i], authors[i], platforms[i]])

    return rows

def main():
    '''
    start_page = 3
    end_page = 15
    50/page * 13 = 650
    '''
    print 'start!'
    for p in range(3,16):
        url = 'https://www.exploit-db.com/webapps/?order_by=date_published&order=desc&pg=' + str(p)
        rows = test(url)
        write_excel(rows)
        print '##'*p
    print 'ok!'

if __name__ == '__main__':
    main()
    #url = 'https://www.exploit-db.com/webapps/?order_by=date_published&order=desc&pg=3'
    #print test(url)




